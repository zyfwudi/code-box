<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Preview</title>
  <!-- es-module-shims -->
</head>
<body>
<script>
  window.addEventListener('error', (e) => {
    window.parent.postMessage({type: 'ERROR', message: e.message})
  })

  window.addEventListener('load', () => {
    window.parent.postMessage({type: 'LOADED', message: ''})
  })

  window.addEventListener('message', ({data}) => {
    if (data?.type === 'UPDATE_FILES') {
      const importmapTag = document.querySelector(
        'script[type="importmap"]',
      );
      if (data.data.importmap) importmapTag.innerHTML = data.data.importmap

      // 即将要清除的样式
      const appStyleTags = document.querySelectorAll('style[id^="style_"]') || []

      // 清除旧app
      const appSrcTag = document.querySelector('#appSrc');
      const oldSrc = appSrcTag.getAttribute('src');
      appSrcTag.remove();

      // 插入新app
      const script = document.createElement('script');
      const newSrc = URL.createObjectURL(
        new Blob([data.data.compileCode], {
          type: 'application/javascript',
        }),
      );
      script.src = newSrc;
      script.id = 'appSrc';
      script.type = 'module';
      script.onload = () => {
        // 防止先移除样式后页面闪烁
        appStyleTags.forEach(div => {
          div.remove();
        });
      }
      document.body.appendChild(script);
      URL.revokeObjectURL(oldSrc);
      window.parent.postMessage({type: 'DONE', message: ''})
    }
  });
</script>
<script type="importmap"></script>
<script type="module" id="appSrc"></script>
<div id="root">
  <div style="position:absolute;top: 0;left:0;width:100%;height:100%;display: flex;justify-content: center;align-items: center;">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="none"><style>@keyframes c-gift-slide{0%{transform:translateX(30px);opacity:0}50%{transform:translateX(0);opacity:1}to{transform:translateX(-30px);opacity:1}}</style><g style="animation:c-gift-slide 3s cubic-bezier(.51,-.16,.3,1.27) both infinite"><path stroke="#0A0A30" stroke-linecap="round" stroke-width="1.5" d="M4.114 12.649v1a2 2 0 002 2h13.528"></path><path fill="#265BFF" fill-rule="evenodd" d="M9.51 7.644a.465.465 0 00-.721.589c.095.117.323.289.57.4.12.054.229.086.313.094.086.008.111-.012.111-.012s.024-.02.034-.107a1.05 1.05 0 00-.03-.325c-.058-.264-.182-.522-.277-.639zm-1.008-.499a1.024 1.024 0 011.44.146c.065.079.127.18.184.292.056-.113.119-.213.183-.292a1.024 1.024 0 111.586 1.295c-.164.202-.471.42-.773.556a1.595 1.595 0 01-.49.14.704.704 0 01-.506-.126.704.704 0 01-.507.126 1.595 1.595 0 01-.49-.14c-.301-.136-.608-.354-.773-.556a1.024 1.024 0 01.146-1.44zm2.894.433a.465.465 0 00-.655.066c-.095.117-.218.375-.277.639a1.05 1.05 0 00-.03.325c.01.087.034.107.034.107s.025.02.112.012a1.05 1.05 0 00.313-.094c.247-.111.474-.283.57-.4a.465.465 0 00-.067-.655zm4.214-2.022a.465.465 0 10-.721.589c.095.117.323.289.57.4.12.054.229.085.313.093.086.009.11-.01.111-.01 0-.001.024-.021.034-.108a1.05 1.05 0 00-.03-.325c-.059-.264-.182-.522-.277-.639zm-1.008-.499a1.024 1.024 0 011.44.146c.065.079.127.18.184.291a1.62 1.62 0 01.183-.29 1.024 1.024 0 111.586 1.294c-.165.201-.471.42-.774.556a1.595 1.595 0 01-.488.14.704.704 0 01-.507-.126.704.704 0 01-.507.126 1.595 1.595 0 01-.49-.14c-.301-.136-.608-.355-.773-.556a1.024 1.024 0 01.146-1.44zm2.894.433a.465.465 0 00-.655.066c-.095.117-.218.375-.277.639a1.05 1.05 0 00-.03.325c.01.087.034.107.034.107s.025.02.112.011a1.05 1.05 0 00.313-.093c.246-.111.474-.283.57-.4a.465.465 0 00-.067-.655z" clip-rule="evenodd"></path><mask id="prefix__a" fill="#fff"><rect width="7.1" height="7.051" x="6.576" y="9.068" rx="1"></rect></mask><rect width="7.1" height="7.051" x="6.576" y="9.068" stroke="#0A0A30" stroke-width="3" mask="url(#prefix__a)" rx="1"></rect><mask id="prefix__b" fill="#fff"><rect width="8" height="9.205" x="12.226" y="6.915" rx="1"></rect></mask><rect width="8" height="9.205" x="12.226" y="6.915" stroke="#0A0A30" stroke-width="3" mask="url(#prefix__b)" rx="1"></rect><path stroke="#0A0A30" stroke-linecap="round" stroke-width="1.5" d="M9.022 16l-2.446 2.446M17.022 16l-2.38 2.38m-10.528.123h16.111"></path></g></svg>
  </div>
</div>
</body>
</html>
